---
title: æŠ½è±¡è¯­æ³•æ ‘ï¼ˆASTï¼‰
---

ç°ä»£å‰ç«¯æ„å»ºåœ¨ AST ä¹‹ä¸Šï¼Œæ— è®ºæ˜¯ ESlintã€Babelã€Webpackï¼Œè¿˜æ˜¯ css å¤„ç†å™¨ã€ä»£ç å‹ç¼©ï¼Œéƒ½æ˜¯ç«™ç«‹åœ¨ AST çš„è‚©è†€ä¸Šã€‚åœ¨æ·±å…¥å­¦ä¹  Babel ä¹‹å‰ï¼Œå…ˆäº†è§£ä¸€äº›å…³äº AST çš„çŸ¥è¯†ã€‚

## AST æ˜¯ä»€ä¹ˆï¼Ÿ

> åœ¨è®¡ç®—æœºç§‘å­¦ä¸­ï¼ŒæŠ½è±¡è¯­æ³•æ ‘ï¼ˆAbstract Syntax Treeï¼ŒASTï¼‰ï¼Œæˆ–ç®€ç§°è¯­æ³•æ ‘ï¼ˆSyntax treeï¼‰ï¼Œæ˜¯æºä»£ç è¯­æ³•ç»“æ„çš„ä¸€ç§æŠ½è±¡è¡¨ç¤ºã€‚å®ƒä»¥æ ‘çŠ¶çš„å½¢å¼è¡¨ç°ç¼–ç¨‹è¯­è¨€çš„è¯­æ³•ç»“æ„ï¼Œæ ‘ä¸Šçš„æ¯ä¸ªèŠ‚ç‚¹éƒ½è¡¨ç¤ºæºä»£ç ä¸­çš„ä¸€ç§ç»“æ„ã€‚

> ä¹‹æ‰€ä»¥è¯´è¯­æ³•æ˜¯â€œæŠ½è±¡â€çš„ï¼Œæ˜¯å› ä¸ºè¿™é‡Œçš„è¯­æ³•å¹¶ä¸ä¼šè¡¨ç¤ºå‡ºçœŸå®è¯­æ³•ä¸­å‡ºç°çš„æ¯ä¸ªç»†èŠ‚ã€‚æ¯”å¦‚ï¼ŒåµŒå¥—æ‹¬å·è¢«éšå«åœ¨æ ‘çš„ç»“æ„ä¸­ï¼Œå¹¶æ²¡æœ‰ä»¥èŠ‚ç‚¹çš„å½¢å¼å‘ˆç°ï¼›è€Œç±»ä¼¼äº if-condition-then è¿™æ ·çš„æ¡ä»¶è·³è½¬è¯­å¥ï¼Œå¯ä»¥ä½¿ç”¨å¸¦æœ‰ä¸¤ä¸ªåˆ†æ”¯çš„èŠ‚ç‚¹æ¥è¡¨ç¤ºã€‚

å¦‚æœçœ‹å®Œå®šä¹‰å¦‚æœè¿˜æ˜¯ä¸€è„¸æ‡µé€¼ï¼Œé‚£ä¹ˆå°±ä¸Šä¸€ä¸ªç®€å•çš„ ğŸŒ° ï¼Œçœ‹çœ‹æŠŠä¸€ä¸ªç®€å•å‡½æ•°è½¬æˆ AST åçš„æ ·å­ã€‚ç¤ºä¾‹ä¸­çš„ AST å¯ä»¥é€šè¿‡ç½‘ç«™ [astexplorer](https://astexplorer.net/)åœ¨çº¿ç”Ÿæˆã€‚

```js
// æºç 
function sum(a, b) {
  return a + b;
}
```

```json
// ç”Ÿæˆçš„ AST
{
  "type": "Program",
  "start": 0,
  "end": 37,
  "body": [
    {
      "type": "FunctionDeclaration",
      "start": 0,
      "end": 37,
      "id": {
        "type": "Identifier",
        "start": 9,
        "end": 12,
        "name": "sum"
      },
      "expression": false,
      "generator": false,
      "async": false,
      "params": [
        {
          "type": "Identifier",
          "start": 13,
          "end": 14,
          "name": "a"
        },
        {
          "type": "Identifier",
          "start": 16,
          "end": 17,
          "name": "b"
        }
      ],
      "body": {
        "type": "BlockStatement",
        "start": 19,
        "end": 37,
        "body": [
          {
            "type": "ReturnStatement",
            "start": 22,
            "end": 35,
            "argument": {
              "type": "BinaryExpression",
              "start": 29,
              "end": 34,
              "left": {
                "type": "Identifier",
                "start": 29,
                "end": 30,
                "name": "a"
              },
              "operator": "+",
              "right": {
                "type": "Identifier",
                "start": 33,
                "end": 34,
                "name": "b"
              }
            }
          }
        ]
      }
    }
  ],
  "sourceType": "module"
}
```

å¯ä»¥çœ‹åˆ° AST æ¯ä¸€å±‚éƒ½æ‹¥æœ‰ç›¸ä¼¼çš„ç»“æ„ï¼š

```json
{
  "type": "FunctionDeclaration",
  "id": {},
  "params": [],
  "body": []
}
```

```json
{
  "type": "Identifier",
  "name": ""
}
```

```json
{
  "type": "BinaryExpression",
  "left": "",
  "operator": "",
  "right": ""
}
```

è¿™æ ·çš„æ¯ä¸€å±‚ç»“æ„ä¹Ÿè¢«å«åš èŠ‚ç‚¹ï¼ˆNodeï¼‰ã€‚ ä¸€ä¸ª AST å¯ä»¥ç”±å•ä¸€çš„èŠ‚ç‚¹æˆ–æ˜¯æˆç™¾ä¸Šåƒä¸ªèŠ‚ç‚¹æ„æˆã€‚ å®ƒä»¬ç»„åˆåœ¨ä¸€èµ·å¯ä»¥æè¿°ç”¨äºé™æ€åˆ†æçš„ç¨‹åºè¯­æ³•ã€‚

æ¯ä¸€ä¸ªèŠ‚ç‚¹éƒ½æœ‰å¦‚ä¸‹æ‰€ç¤ºçš„æ¥å£ï¼š

```ts
interface Node {
  type: string;
}
```

`type` å­—æ®µè¡¨ç¤ºèŠ‚ç‚¹çš„ç±»å‹ï¼ˆå¦‚ï¼š`FunctionDeclaration`ã€`Identifier`ã€`BinaryExpression`ï¼‰ã€‚æ¯ä¸€ç§ç±»å‹çš„èŠ‚ç‚¹è¿˜å®šä¹‰äº†ä¸€äº›é™„åŠ å±æ€§æ¥è¿›ä¸€æ­¥æè¿°è¯¥èŠ‚ç‚¹ã€‚

è¿˜æœ‰ä¸€äº›å±æ€§ç”¨æ¥æè¿°è¯¥èŠ‚ç‚¹åœ¨åŸå§‹ä»£ç ä¸­çš„ä½ç½®ã€‚

```json
{
  "type": "",
  "start": 0,
  "end": 55,
  "loc": {
    "start": {
      "line": 1,
      "column": 0
    },
    "end": {
      "line": 3,
      "column": 1
    }
  }
}
```

## ç”Ÿæˆ AST çš„æ­¥éª¤

ç”Ÿæˆ AST åˆ†ä¸ºä¸¤ä¸ªé˜¶æ®µï¼Œåˆ†åˆ«æ˜¯è¯æ³•åˆ†æï¼ˆLexical Analysisï¼‰å’Œè¯­æ³•åˆ†æï¼ˆSyntactic Analysisï¼‰ã€‚

### è¯æ³•åˆ†æ/æ‰«æï¼ˆScanningï¼‰

è¯æ³•åˆ†æé˜¶æ®µä»å·¦å‘å³é€è¡Œæ‰«ææºç¨‹åºçš„å­—ç¬¦ï¼Œè¯†åˆ«å‡ºå„ä¸ªå•è¯ï¼Œç¡®å®šå•è¯çš„ç±»å‹ï¼Œå°†è¯†åˆ«å‡ºçš„å•è¯è½¬æ¢æˆç»Ÿä¸€çš„è¯æ³•å•å…ƒï¼ˆtokenï¼‰å½¢å¼ã€‚

`token` <ç§åˆ«ç ï¼Œå±æ€§å€¼>
| å•è¯ç±»å‹ | ç§åˆ« | ç§åˆ«ç  |
| -------- | -------------------------------------------------------------------- | :--------------------------: |
| å…³é”®å­— | ifã€elseã€thenã€... | ä¸€è¯ä¸€ç  |
| æ ‡è¯†ç¬¦ | å˜é‡åã€æ–¹æ³•åã€... | å¤šè¯ä¸€ç  |
| å¸¸é‡ | æ•°å­—ã€å­—ç¬¦ä¸²ã€å¸ƒå°”å€¼ | ä¸€å‹ä¸€ç  |
| è¿ç®—æ³• | ç®—æœ¯ï¼ˆ+ - \* / ++ --ï¼‰<br> å…³ç³»ï¼ˆ> < == != >= <=ï¼‰<br>é€»è¾‘ï¼ˆ& \| ~ï¼‰ | ä¸€è¯ä¸€ç  <br>æˆ–<br> ä¸€å‹ä¸€ç  |
| ç•Œé™ç¬¦ | ; () = {} | ä¸€è¯ä¸€ç  |

ä¸¾ä¸ªä¾‹å­: `a + b`ï¼Œè¿™æ®µç¨‹åºé€šå¸¸ä¼šè¢«åˆ†è§£æˆä¸ºä¸‹é¢è¿™äº›è¯æ³•å•å…ƒ: `a`ã€`+`ã€`b`ï¼Œç©ºæ ¼æ˜¯å¦è¢«å½“æˆæ­¤æ³•å•å…ƒï¼Œå–å†³äºç©ºæ ¼åœ¨è¿™é—¨è¯­è¨€ä¸­çš„æ„ä¹‰ã€‚

ä¸‹é¢çš„ä»£ç å°±æ˜¯åˆ©ç”¨[è¯æ³•åˆ†æç½‘ç«™](https://esprima.org/demo/parse.html)è§£æ `a + b` åå¾—åˆ°çš„è¯æ³•å•å…ƒåºåˆ—ï¼ˆtoeknsï¼‰ã€‚

```js
[
  { type: 'Identifier', value: 'a' },
  { type: 'Punctuator', value: '+' },
  { type: 'Identifier', value: 'b' },
];
```

å¯¹äºè¯æ³•åˆ†ææ„Ÿå…´è¶£çš„åŒå­¦å¯ä»¥é˜…è¯» `@babel/parser` ä¸­çš„è¯æ³•åˆ†ææ–¹æ³• [Tokenizer](https://github.com/babel/babel/blob/master/packages/babel-parser/src/tokenizer/index.js)ã€‚

### è¯­æ³•åˆ†æï¼ˆParsingï¼‰

è¯­æ³•åˆ†æå™¨ä»è¯æ³•åˆ†æå™¨è¾“å‡ºçš„ token åºåˆ—ä¸­è¯†åˆ«å‡ºå„ç±»çŸ­è¯­ï¼Œå¹¶è½¬æ¢æˆ AST çš„å½¢å¼ã€‚

## Babel å·¥ä½œæµç¨‹

![babelå·¥ä½œæµ](/images/babel/babel.jpeg)

Babel å·¥ä½œæµç¨‹åˆ†ä¸ºä¸‰æ­¥ï¼š`Parse`ã€`Transform`ã€`Generator`ã€‚

### Parse è§£æ

ç¬¬ä¸€æ­¥ï¼Œ`Babel` ä¼šåˆ©ç”¨ `@babel/parse` åŒ…æä¾›çš„æ–¹æ³•ï¼Œç»è¿‡ `è¯æ³•åˆ†æ` å’Œ `è¯­æ³•åˆ†æ` ä¸¤ä¸ªæ­¥éª¤ï¼Œå°†æºä»£ç è§£æä¸ºæŠ½è±¡è¯­æ³•æ ‘ï¼ˆASTï¼‰çš„å½¢å¼ã€‚

### Transform è½¬æ¢

ç¬¬äºŒæ­¥ï¼Œåœ¨å¾—åˆ°æºä»£ç çš„ AST åï¼Œ`Babel` ä¼šä½¿ç”¨ `@babel/traverse` éå†æ•´ä¸ª ASTï¼Œå¹¶åœ¨æ­¤è¿‡ç¨‹ä¸­æ ¹æ®éœ€æ±‚ä¿®æ”¹ ASTã€‚

#### Visitorsï¼ˆè®¿é—®è€…ï¼‰

Transform é˜¶æ®µï¼ŒBabel ä¼šç»´æŠ¤ä¸€ä¸ª `visitor` å¯¹è±¡ï¼Œè¿™é‡Œå¯¹è±¡é‡Œå®šä¹‰äº†ç”¨äºåœ¨ AST ä¸­è·å–å…·ä½“èŠ‚ç‚¹çš„æ–¹æ³•ã€‚ä¸‹é¢è¯·çœ‹ä¸€ä¸ªä¾‹å­ï¼š

```js
const visitor = {
  Identifier(path) {
    // è¾“å‡ºå½“å‰æ ‡è¯†ç¬¦çš„åå­—
    console.log(path.node.name);
  },
  FunctionDeclaration(path) {
    // è¾“å‡ºå‡½æ•°å®šä¹‰çš„åå­—
    console.log(path.node.name);
  },
};
```

> æ³¨æ„ï¼š`Identifier() { ... }` æ˜¯ `Identifier: { enter() { ... } }` çš„ç®€å†™å½¢å¼ã€‚

ä¸Šé¢çš„ `visitor` å¯¹è±¡ä¸­å®šä¹‰äº† 2 ä¸ªæ–¹æ³•ï¼Œåˆ†åˆ«æ˜¯ `Identifier` å’Œ `FunctionDeclaration`ã€‚`Identifier` æ–¹æ³•åœ¨éå†åˆ° `type: Identifier` çš„èŠ‚ç‚¹æ—¶ä¼šæ‰§è¡Œï¼Œè€Œ `FunctionDeclaration` æ–¹æ³•ä¼šåœ¨èŠ‚ç‚¹çš„ `type` ä¸º `FunctionDeclaration` æ—¶æ‰§è¡Œã€‚

æ‰€ä»¥åœ¨ä¸‹é¢çš„ä»£ç ä¸­ `Identifier()` ä¼šè¢«è°ƒç”¨å››æ¬¡ã€‚

```js
function square(n) {
  return n * n;
}

// Identifier() ä¼šæ‰“å°å‡ºä»¥ä¸‹å†…å®¹
// square
// n
// n
// n
```

è¿™äº›è°ƒç”¨éƒ½å‘ç”Ÿåœ¨**è¿›å…¥**èŠ‚ç‚¹æ—¶ï¼Œä¸è¿‡æˆ‘ä»¬ä¹Ÿå¯ä»¥åœ¨**é€€å‡º**æ—¶è°ƒç”¨è®¿é—®è€…æ–¹æ³•ã€‚å°†è®¿é—®è€…æ–¹æ³•ä¿®æ”¹ä¸€ä¸‹ï¼š

```js
const visitor = {
  Identifier: {
    enter(path) {
      // è¿›å…¥æ—¶
    },
    exit(path) {
      // é€€å‡ºæ—¶
    },
  },
};
```

#### Pathsï¼ˆè·¯å¾„ï¼‰

è®¿é—®è€…æ–¹æ³•æ¥æ”¶ä¸€ä¸ª `path` å¯¹è±¡å‚æ•°ï¼Œè¿™ä¸ªå¯¹è±¡ä»£è¡¨å½“å‰èŠ‚ç‚¹çš„è·¯å¾„ã€‚å¯ä»¥é€šè¿‡ `path` è®¿é—®å½“å‰èŠ‚ç‚¹ã€å½“å‰èŠ‚ç‚¹çš„çˆ¶èŠ‚ç‚¹ã€è¿˜æœ‰å…¶ä»– Babel æ·»åŠ åˆ°è¯¥è·¯å¾„ä¸Šçš„ä¸€äº›[å…ƒæ•°æ®](https://github.com/jamiebuilds/babel-handbook/blob/master/translations/zh-Hans/plugin-handbook.md#paths%E8%B7%AF%E5%BE%84)ã€‚

```json
// path å¯¹è±¡
{
  "parent": {
    "type": "FunctionDeclaration",
    "id": {...},
    ....
  },
  "node": {
    "type": "Identifier",
    "name": "square"
  },
  ...
}
```

#### Stateï¼ˆçŠ¶æ€ï¼‰

ä¿®æ”¹ AST æ—¶è¿˜è¦è€ƒè™‘ä»£ç çš„çŠ¶æ€ã€‚æ¯”å¦‚æœ‰ä»¥ä¸‹çš„ä¾‹å­ï¼Œæˆ‘ä»¬è¦å°† `square` æ–¹æ³•ä¸­çš„æ ‡è¯†ç¬¦ `n` ä¿®æ”¹ä¸º `x`ï¼Œè¿™æ—¶å€™ä¸èƒ½ç›´æ¥ä½¿ç”¨ `Identifier` è®¿é—®è€…æ–¹æ³•ï¼Œå¦åˆ™ä¼šå°†æ–¹æ³•å¤–çš„å…¶ä»–åŒåçš„æ ‡è¯†ç¬¦ä¸€èµ·ä¿®æ”¹æ‰ã€‚

```js
function square(n) {
  return n * n;
}

const n = 1;
```

å¯¹äºè¿™ç§æƒ…å†µï¼Œå¯ä»¥ä½¿ç”¨ `FunctionDeclaration` è®¿é—®è€…æ–¹æ³•ï¼Œé€šè¿‡è¿™ä¸ªæ–¹æ³•æ‰¾åˆ° `square` ï¼Œç„¶åå†æ·±å…¥é€’å½’æŸ¥æ‰¾é€’å½’æŸ¥æ‰¾ã€‚

```js
const updateParamNameVisitor = {
  Identifier(path) {
    if (path.node.name === this.paramName) {
      path.node.name = 'x';
    }
  },
};

const visitor = {
  FunctionDeclaration(path) {
    const param = path.node.params[0];
    const paramName = param.name;
    param.name = 'x';

    path.traverse({
      Identifier(path) {
        if (path.node.name === paramName) {
          path.node.name = 'x';
        }
      },
    });
  },
};
```

#### Scopesï¼ˆä½œç”¨åŸŸï¼‰

JavaScript æ”¯æŒè¯æ³•ä½œç”¨åŸŸï¼Œåœ¨åµŒå¥—çš„ä»£ç å—ä¸­å¯ä»¥åˆ›å»ºå‡ºæ–°çš„ä½œç”¨åŸŸã€‚å†…éƒ¨ä½œç”¨åŸŸå¯ä»¥è®¿é—®å¤–å±‚ä½œç”¨åŸŸçš„å˜é‡ã€å‡½æ•°ã€ç±»ç­‰ï¼Œå¯ä»¥ç»Ÿä¸€ç§°è¿™äº›ä¸ºå¼•ç”¨ï¼Œè€Œä¸”å†…éƒ¨ä½œç”¨åŸŸè¿˜å¯ä»¥åˆ›å»ºå’Œå¤–å±‚ä½œç”¨åŸŸåŒåçš„å¼•ç”¨ã€‚å› æ­¤ï¼Œåœ¨ä¿®æ”¹ AST æ—¶ï¼Œå¿…é¡»æ³¨æ„å¼•ç”¨çš„ä½œç”¨åŸŸã€‚

å¹¸è¿çš„æ˜¯ï¼ŒBabel æ›¿æˆ‘ä»¬ç»´æŠ¤äº†å¼•ç”¨å’Œä½œç”¨åŸŸä¹‹é—´çš„å…³ç³»ï¼Œè¿™ç§å…³ç³»ç§°ä¹‹ä¸ºï¼š**ç»‘å®šï¼ˆbindingï¼‰**ã€‚å¯ä»¥é€šè¿‡ `path.scope.bindings` è·å–å½“å‰è·¯å¾„æ‰€å±ä½œç”¨åŸŸå†…çš„æ‰€æœ‰å¼•ç”¨çš„ç»‘å®šå…³ç³»ã€‚å•ä¸ªç»‘å®šçœ‹èµ·æ¥å°±åƒè¿™æ ·ï¼š

```js
{
  identifier: node,
  scope: scope,
  path: path,
  kind: 'var',

  // æ˜¯å¦è¢«å¼•ç”¨
  referenced: true,
  // å¼•ç”¨æ•°é‡
  references: 3,
  // å¼•ç”¨è·¯å¾„
  referencePaths: [path, path, path],

  constant: false,
  constantViolations: [path]
}
```

æœ‰äº†è¿™äº›ä¿¡æ¯ä½ å°±å¯ä»¥æŸ¥æ‰¾ä¸€ä¸ªç»‘å®šçš„æ‰€æœ‰å¼•ç”¨ï¼Œå¹¶ä¸”çŸ¥é“è¿™æ˜¯ä»€ä¹ˆç±»å‹çš„ç»‘å®š(å‚æ•°ï¼Œå®šä¹‰ç­‰ç­‰)ï¼ŒæŸ¥æ‰¾å®ƒæ‰€å±çš„ä½œç”¨åŸŸï¼Œæˆ–è€…æ‹·è´å®ƒçš„æ ‡è¯†ç¬¦ã€‚ ä½ ç”šè‡³å¯ä»¥çŸ¥é“å®ƒæ˜¯ä¸æ˜¯å¸¸é‡ï¼Œå¦‚æœä¸æ˜¯ï¼Œé‚£ä¹ˆæ˜¯å“ªä¸ªè·¯å¾„ä¿®æ”¹äº†å®ƒã€‚

```js
// æºä»£ç 
function log() {
  let str = '11111';
  str = '22222';
  return str;
}

// å¯ä»¥åˆ©ç”¨æ ‡è¯†ç¬¦çš„å¼•ç”¨å…³ç³»ï¼Œè¿™æ ·è½¬æ¢ä»£ç 
function log() {
  return '22222';
}
```

### Generator ç”Ÿæˆ

ç»è¿‡ä¸Šä¸€æ­¥çš„ AST ä¿®æ”¹åï¼Œéœ€è¦å°†å…¶å†è½¬æ¢ä¸ºä»£ç ï¼Œè¿™æ—¶å€™å°±ä¼šç”¨åˆ° `@babel/generator`ã€‚

## å‚è€ƒèµ„æ–™

- AST è¯¦è§£ä¸è¿ç”¨ï¼šhttps://zhuanlan.zhihu.com/p/266697614
- ESTree AST è§„èŒƒï¼šhttps://github.com/estree/estree
