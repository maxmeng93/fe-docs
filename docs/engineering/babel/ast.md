---
title: æŠ½è±¡è¯­æ³•æ ‘ï¼ˆASTï¼‰
---

ç°ä»£å‰ç«¯æ„å»ºåœ¨ AST ä¹‹ä¸Šï¼Œæ— è®ºæ˜¯ ESlintã€Babelã€Webpackï¼Œè¿˜æ˜¯ css å¤„ç†å™¨ã€ä»£ç å‹ç¼©ï¼Œéƒ½æ˜¯ç«™ç«‹åœ¨ AST çš„è‚©è†€ä¸Šã€‚åœ¨æ·±å…¥å‰ç«¯å·¥ç¨‹åŒ–ä¹‹å‰ï¼Œå…ˆäº†è§£ä¸€äº›å…³äº AST çš„çŸ¥è¯†ã€‚

## AST æ˜¯ä»€ä¹ˆï¼Ÿ

> åœ¨è®¡ç®—æœºç§‘å­¦ä¸­ï¼ŒæŠ½è±¡è¯­æ³•æ ‘ï¼ˆAbstract Syntax Treeï¼ŒASTï¼‰ï¼Œæˆ–ç®€ç§°è¯­æ³•æ ‘ï¼ˆSyntax treeï¼‰ï¼Œæ˜¯æºä»£ç è¯­æ³•ç»“æ„çš„ä¸€ç§æŠ½è±¡è¡¨ç¤ºã€‚å®ƒä»¥æ ‘çŠ¶çš„å½¢å¼è¡¨ç°ç¼–ç¨‹è¯­è¨€çš„è¯­æ³•ç»“æ„ï¼Œæ ‘ä¸Šçš„æ¯ä¸ªèŠ‚ç‚¹éƒ½è¡¨ç¤ºæºä»£ç ä¸­çš„ä¸€ç§ç»“æ„ã€‚

> ä¹‹æ‰€ä»¥è¯´è¯­æ³•æ˜¯â€œæŠ½è±¡â€çš„ï¼Œæ˜¯å› ä¸ºè¿™é‡Œçš„è¯­æ³•å¹¶ä¸ä¼šè¡¨ç¤ºå‡ºçœŸå®è¯­æ³•ä¸­å‡ºç°çš„æ¯ä¸ªç»†èŠ‚ã€‚æ¯”å¦‚ï¼ŒåµŒå¥—æ‹¬å·è¢«éšå«åœ¨æ ‘çš„ç»“æ„ä¸­ï¼Œå¹¶æ²¡æœ‰ä»¥èŠ‚ç‚¹çš„å½¢å¼å‘ˆç°ï¼›è€Œç±»ä¼¼äº if-condition-then è¿™æ ·çš„æ¡ä»¶è·³è½¬è¯­å¥ï¼Œå¯ä»¥ä½¿ç”¨å¸¦æœ‰ä¸¤ä¸ªåˆ†æ”¯çš„èŠ‚ç‚¹æ¥è¡¨ç¤ºã€‚

å¦‚æœçœ‹å®Œå®šä¹‰å¦‚æœè¿˜æ˜¯ä¸€è„¸æ‡µé€¼ï¼Œé‚£ä¹ˆå°±ä¸Šä¸€ä¸ªç®€å•çš„ ğŸŒ° ï¼Œçœ‹çœ‹æŠŠä¸€ä¸ªç®€å•å‡½æ•°è½¬æˆ AST åçš„æ ·å­ã€‚ç¤ºä¾‹ä¸­çš„ AST å¯ä»¥é€šè¿‡ç½‘ç«™ [astexplorer](https://astexplorer.net/)åœ¨çº¿ç”Ÿæˆã€‚

```js
// æºç 
function sum(a, b) {
  return a + b;
}
```

```json
// ç”Ÿæˆçš„ AST
{
  "type": "Program",
  "start": 0,
  "end": 37,
  "body": [
    {
      "type": "FunctionDeclaration",
      "start": 0,
      "end": 37,
      "id": {
        "type": "Identifier",
        "start": 9,
        "end": 12,
        "name": "sum"
      },
      "expression": false,
      "generator": false,
      "async": false,
      "params": [
        {
          "type": "Identifier",
          "start": 13,
          "end": 14,
          "name": "a"
        },
        {
          "type": "Identifier",
          "start": 16,
          "end": 17,
          "name": "b"
        }
      ],
      "body": {
        "type": "BlockStatement",
        "start": 19,
        "end": 37,
        "body": [
          {
            "type": "ReturnStatement",
            "start": 22,
            "end": 35,
            "argument": {
              "type": "BinaryExpression",
              "start": 29,
              "end": 34,
              "left": {
                "type": "Identifier",
                "start": 29,
                "end": 30,
                "name": "a"
              },
              "operator": "+",
              "right": {
                "type": "Identifier",
                "start": 33,
                "end": 34,
                "name": "b"
              }
            }
          }
        ]
      }
    }
  ],
  "sourceType": "module"
}
```

å¯ä»¥çœ‹åˆ° AST æ¯ä¸€å±‚éƒ½æ‹¥æœ‰ç›¸ä¼¼çš„ç»“æ„ï¼š

```json
{
  "type": "FunctionDeclaration",
  "id": {},
  "params": [],
  "body": []
}
```

```json
{
  "type": "Identifier",
  "name": ""
}
```

```json
{
  "type": "BinaryExpression",
  "left": "",
  "operator": "",
  "right": ""
}
```

è¿™æ ·çš„æ¯ä¸€å±‚ç»“æ„ä¹Ÿè¢«å«åš èŠ‚ç‚¹ï¼ˆNodeï¼‰ã€‚ ä¸€ä¸ª AST å¯ä»¥ç”±å•ä¸€çš„èŠ‚ç‚¹æˆ–æ˜¯æˆç™¾ä¸Šåƒä¸ªèŠ‚ç‚¹æ„æˆã€‚ å®ƒä»¬ç»„åˆåœ¨ä¸€èµ·å¯ä»¥æè¿°ç”¨äºé™æ€åˆ†æçš„ç¨‹åºè¯­æ³•ã€‚

æ¯ä¸€ä¸ªèŠ‚ç‚¹éƒ½æœ‰å¦‚ä¸‹æ‰€ç¤ºçš„æ¥å£ï¼š

```ts
interface Node {
  type: string;
}
```

`type` å­—æ®µè¡¨ç¤ºèŠ‚ç‚¹çš„ç±»å‹ï¼ˆå¦‚ï¼š`FunctionDeclaration`ã€`Identifier`ã€`BinaryExpression`ï¼‰ã€‚æ¯ä¸€ç§ç±»å‹çš„èŠ‚ç‚¹è¿˜å®šä¹‰äº†ä¸€äº›é™„åŠ å±æ€§æ¥è¿›ä¸€æ­¥æè¿°è¯¥èŠ‚ç‚¹ã€‚

è¿˜æœ‰ä¸€äº›å±æ€§ç”¨æ¥æè¿°è¯¥èŠ‚ç‚¹åœ¨åŸå§‹ä»£ç ä¸­çš„ä½ç½®ã€‚

```json
{
  "type": "",
  "start": 0,
  "end": 55,
  "loc": {
    "start": {
      "line": 1,
      "column": 0
    },
    "end": {
      "line": 3,
      "column": 1
    }
  }
}
```

## ç”Ÿæˆ AST çš„æ­¥éª¤

ç”Ÿæˆ AST åˆ†ä¸ºä¸¤ä¸ªé˜¶æ®µï¼Œåˆ†åˆ«æ˜¯è¯æ³•åˆ†æï¼ˆLexical Analysisï¼‰å’Œè¯­æ³•åˆ†æï¼ˆSyntactic Analysisï¼‰ã€‚

### è¯æ³•åˆ†æ/æ‰«æï¼ˆScanningï¼‰

è¯æ³•åˆ†æé˜¶æ®µä»å·¦å‘å³é€è¡Œæ‰«ææºç¨‹åºçš„å­—ç¬¦ï¼Œè¯†åˆ«å‡ºå„ä¸ªå•è¯ï¼Œç¡®å®šå•è¯çš„ç±»å‹ï¼Œå°†è¯†åˆ«å‡ºçš„å•è¯è½¬æ¢æˆç»Ÿä¸€çš„è¯æ³•å•å…ƒï¼ˆtokenï¼‰å½¢å¼ã€‚

tokenï¼š<ç§åˆ«ç ï¼Œå±æ€§å€¼>
| å•è¯ç±»å‹ | ç§åˆ« | ç§åˆ«ç  |
| -------- | -------------------------------------------------------------------- | :--------------------------: |
| å…³é”®å­— | ifã€elseã€thenã€... | ä¸€è¯ä¸€ç  |
| æ ‡è¯†ç¬¦ | å˜é‡åã€æ–¹æ³•åã€... | å¤šè¯ä¸€ç  |
| å¸¸é‡ | æ•°å­—ã€å­—ç¬¦ä¸²ã€å¸ƒå°”å€¼ | ä¸€å‹ä¸€ç  |
| è¿ç®—æ³• | ç®—æœ¯ï¼ˆ+ - \* / ++ --ï¼‰<br> å…³ç³»ï¼ˆ> < == != >= <=ï¼‰<br>é€»è¾‘ï¼ˆ& \| ~ï¼‰ | ä¸€è¯ä¸€ç  <br>æˆ–<br> ä¸€å‹ä¸€ç  |
| ç•Œé™ç¬¦ | ; () = {} | ä¸€è¯ä¸€ç  |

ä¸¾ä¸ªä¾‹å­: `a + b`, è¿™æ®µç¨‹åºé€šå¸¸ä¼šè¢«åˆ†è§£æˆä¸ºä¸‹é¢è¿™äº›è¯æ³•å•å…ƒ: `a`ã€`+`ã€`b`ï¼Œç©ºæ ¼æ˜¯å¦è¢«å½“æˆæ­¤æ³•å•å…ƒï¼Œå–å†³äºç©ºæ ¼åœ¨è¿™é—¨è¯­è¨€ä¸­çš„æ„ä¹‰ã€‚

ä¸‹é¢çš„ä»£ç å°±æ˜¯åˆ©ç”¨[è¯æ³•åˆ†æç½‘ç«™](https://esprima.org/demo/parse.html)è§£æ `a + b` åå¾—åˆ°çš„è¯æ³•å•å…ƒæ•°ç»„ï¼ˆtoeknsï¼‰ã€‚

```js
[
  { type: 'Identifier', value: 'a' },
  { type: 'Punctuator', value: '+' },
  { type: 'Identifier', value: 'b' },
];
```

å¯¹äºè¯æ³•åˆ†ææ„Ÿå…´è¶£çš„åŒå­¦å¯ä»¥é˜…è¯» `@babel/parser` ä¸­çš„è¯æ³•åˆ†ææ–¹æ³• [Tokenizer](https://github.com/babel/babel/blob/master/packages/babel-parser/src/tokenizer/index.js)ã€‚

### è¯­æ³•åˆ†æï¼ˆParsingï¼‰

è¯­æ³•åˆ†æå™¨ä»è¯æ³•åˆ†æå™¨è¾“å‡ºçš„ token åºåˆ—ä¸­è¯†åˆ«å‡ºå„ç±»çŸ­è¯­ï¼Œå¹¶æ„é€ è¯­æ³•åˆ†ææ ‘ã€‚
è¯­æ³•åˆ†æé˜¶æ®µä¼šæŠŠä¸€ä¸ªä»¤ç‰Œæµè½¬æ¢æˆ AST çš„å½¢å¼ã€‚ è¿™ä¸ªé˜¶æ®µä¼šä½¿ç”¨ä»¤ç‰Œä¸­çš„ä¿¡æ¯æŠŠå®ƒä»¬è½¬æ¢æˆä¸€ä¸ª AST çš„è¡¨è¿°ç»“æ„ï¼Œè¿™æ ·æ›´æ˜“äºåç»­çš„æ“ä½œã€‚

![babelå·¥ä½œæµ](/images/babel/babel.jpeg)

## å‚è€ƒèµ„æ–™

- AST è¯¦è§£ä¸è¿ç”¨ï¼šhttps://zhuanlan.zhihu.com/p/266697614
- ESTree AST è§„èŒƒï¼šhttps://github.com/estree/estree
